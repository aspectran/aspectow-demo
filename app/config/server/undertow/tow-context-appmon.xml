<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran 9.0//EN"
        "https://aspectran.com/dtd/aspectran-9.dtd">
<aspectran>

    <description>
        Aspectran configuration for setting up the servlet context.
    </description>

    <environment>
        <property name="tow.context.appmon.name">appmon</property>
        <property name="tow.context.appmon.config">classpath:com/aspectran/appmon/context/aspectran-config.apon</property>
    </environment>

    <bean id="tow.context.appmon.servletContext"
          class="com.aspectran.undertow.server.servlet.TowServletContext"
          scope="prototype">
        <property name="deploymentName">%{tow.context.appmon.name}</property>
        <property name="contextPath">/%{tow.context.appmon.name}</property>
        <property name="resourceManager">
            <bean class="com.aspectran.undertow.server.handler.resource.TowResourceManager">
                <property name="base">/webapps/%{tow.context.appmon.name}</property>
            </bean>
        </property>
        <property name="scratchDir">/work/_webapps/%{tow.context.appmon.name}</property>
        <property name="sessionManager">#{tow.context.appmon.sessionManager}</property>
        <property name="servletSessionConfig">
            <bean class="io.undertow.servlet.api.ServletSessionConfig">
                <property name="sessionTrackingModes" type="set">
                    <value>#{class:jakarta.servlet.SessionTrackingMode^COOKIE}</value>
                </property>
                <property name="path" value="/"/>
                <properties profile="prod">
                    <item name="domain" value="%{tow.server.domain}"/>
                </properties>
            </bean>
        </property>
        <property name="initParams" type="map">
            <entry name="aspectran:config">%{tow.context.appmon.config}</entry>
        </property>
        <property name="servlets" type="array">
            <bean class="com.aspectran.undertow.server.servlet.DefaultJspServlet">
                <property name="loadOnStartup" valueType="int">0</property>
            </bean>
            <bean class="com.aspectran.undertow.server.servlet.TowServlet">
                <argument>webActivityServlet</argument>
                <argument>com.aspectran.web.servlet.WebActivityServlet</argument>
                <property name="mappings" type="array">
                    <value>/</value>
                </property>
                <property name="loadOnStartup" valueType="int">1</property>
            </bean>
        </property>
        <property name="servletContainerInitializers" type="array">
            <bean class="com.aspectran.undertow.server.servlet.TowJasperInitializer">
                <property name="tldResources" type="array">
                    <value>classpath:com/aspectran/web/support/tags/aspectran.tld</value>
                    <value>/webapps/%{tow.context.appmon.name}/WEB-INF/taglibs/</value>
                </property>
            </bean>
        </property>
        <property name="webSocketServerContainerInitializer">
            <bean class="com.aspectran.undertow.server.servlet.TowWebSocketServerContainerInitializer">
                <property name="directBuffers" valueType="boolean">false</property>
                <property name="bufferSize" valueType="int">1024</property>
            </bean>
        </property>
    </bean>

    <bean id="tow.context.appmon.sessionManager"
          class="com.aspectran.undertow.server.session.TowSessionManager"
          scope="prototype">
        <properties profile="!prod">
            <item name="sessionManagerConfig">
                <bean class="com.aspectran.core.context.config.SessionManagerConfig">
                    <argument>
                        workerName: am0
                        maxActiveSessions: 999
                        maxIdleSeconds: 600
                        evictionIdleSeconds: 300
                        scavengingIntervalSeconds: 180
                        clusterEnabled: false
                    </argument>
                </bean>
            </item>
            <item name="sessionStore">
                <bean class="com.aspectran.core.component.session.FileSessionStoreFactoryBean">
                    <property name="storeDir">/work/_sessions/%{tow.context.appmon.name}</property>
                </bean>
            </item>
        </properties>
        <properties profile="prod">
            <item name="sessionManagerConfig">
                <bean class="com.aspectran.core.context.config.SessionManagerConfig">
                    <argument>
                        workerName: am0
                        maxActiveSessions: 999
                        maxIdleSeconds: 600
                        evictionIdleSeconds: 300
                        scavengingIntervalSeconds: 180
                        clusterEnabled: true
                    </argument>
                </bean>
            </item>
            <item name="sessionStore">
                <bean class="com.aspectran.core.component.session.redis.lettuce.DefaultLettuceSessionStoreFactoryBean">
                    <property name="poolConfig">
                        <bean class="com.aspectran.core.component.session.redis.lettuce.RedisConnectionPoolConfig">
                            <property name="uri">%{system:redis.uri}/13</property>
                        </bean>
                    </property>
                </bean>
            </item>
        </properties>
    </bean>

</aspectran>
